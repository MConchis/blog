<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Portfolio — Haluk Diriker</title>
  <link rel="stylesheet" href="../css/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Source+Serif+4:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
</head>
<body>
  <div id="site-header" data-include="../partials/header.html"></div>

  <main class="container">
    <h1>Portfolio</h1>
    <p class="lede">A list of projects I've worked on that have released or had over one year of development</p>

    <section>
      <div id="projects" class="projects-grid" aria-live="polite">
        <!-- Projects will be rendered here -->
      </div>
    </section>
  </main>

  <div id="site-footer" data-include="../partials/footer.html"></div>
  <script src="../js/includes.js"></script>
  <script src="../js/gallery.js"></script>
  <script src="../js/spa.js"></script>
  <script>
    // Small styling tweaks to ensure screenshots align visually in the portfolio page
    (function addStyles(){
      const css = `
        .projects-grid { display:flex; flex-direction:column; gap:28px; }
        .project-card { display:flex; flex-direction:column; gap:12px; padding:18px; border-radius:8px; background:var(--card-bg,#fff); box-shadow:var(--card-shadow,0 1px 0 rgba(0,0,0,0.04)); }
        .project-header{ display:flex; gap:12px; align-items:center }
        .project-logo{ width:64px; height:64px; object-fit:contain }
        .project-info h3{ margin:0; font-size:1.05rem }
        .screenshots{ display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap }
        .screenshot-figure{ display:flex; flex-direction:column; gap:6px; }
        .screenshots img{ width:220px; height:140px; object-fit:cover; border-radius:6px; background:#f3f3f3; display:block }
        .project-image-caption{ font-size:0.8rem; color:var(--muted); margin:0; max-width:220px }
        @media (max-width:700px){ .screenshots img{ width:48vw; height:32vw } }
      `;
      const s=document.createElement('style'); s.textContent=css; document.head.appendChild(s);
    })();

    // Convert plain text descriptions from JSON into safe HTML paragraphs
    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function descriptionToHtml(raw) {
      if (!raw) return '';
      // Normalize newlines
      let s = String(raw).replace(/\r\n/g,'\n').replace(/\r/g,'\n');
      // Split on two-or-more newlines for paragraphs
      const paras = s.split(/\n{2,}/g);
      return paras.map(p => '<p class="lede">' + escapeHtml(p).replace(/\n/g, '<br>') + '</p>').join('');
    }

    // Fetch and render projects.json with fallback for / paths
    const attemptFetch = async () => {
      const urls = ['./projects.json'];
      for (const url of urls) {
        try {
          const res = await fetch(url, {cache:'no-store'});
          if (res.ok) return res;
        } catch (e) {
          console.warn('Failed to fetch ' + url);
        }
      }
      throw new Error('Could not load projects.json from any location');
    };

    attemptFetch().then(r=>r.json()).then(projects=>{
      const mount = document.getElementById('projects');
      if (!projects || !projects.length) { mount.innerHTML = '<p>No projects found.</p>'; return }
      projects.forEach(p=>{
        const art = document.createElement('article'); art.className='project-card';

        const header = document.createElement('div'); header.className='project-header';
        if (p.logo) {
          const img = document.createElement('img'); img.className='project-logo'; img.src=p.logo; img.alt = p.title + ' logo'; header.appendChild(img);
        }
        const info = document.createElement('div'); info.className='project-info';
        const h3 = document.createElement('h3'); h3.textContent = p.title || 'Untitled';
        const meta = document.createElement('div'); meta.className='project-meta'; meta.textContent = p.role || '';
        info.appendChild(h3); if (p.role) info.appendChild(meta);
        header.appendChild(info);

        art.appendChild(header);

        if (p.description) {
          // Convert JSON description text into safe HTML paragraphs and line-breaks
          const html = descriptionToHtml(p.description);
          const wrapper = document.createElement('div');
          wrapper.innerHTML = html;
          art.appendChild(wrapper);
        }

        if (p.images && p.images.length) {
          const shots = document.createElement('div'); shots.className='screenshots';
          p.images.forEach((src, idx)=>{
            const im = document.createElement('img'); im.className='screenshot screenshot-link'; im.src = src; im.setAttribute('data-full', src); im.alt = p.title + ' screenshot';
            const fig = document.createElement('figure'); fig.className = 'screenshot-figure';
            fig.appendChild(im);
            const cap = document.createElement('figcaption'); cap.className = 'project-image-caption';
            const credit = p.imageCredit ? p.imageCredit : '© Image credit placeholder.';
            cap.textContent = credit;
            fig.appendChild(cap);
            shots.appendChild(fig);
          });
          art.appendChild(shots);
        }

        mount.appendChild(art);
      });

      // Initialize gallery bindings after DOM insertion
      if (window.initGallery) { try { window.initGallery(); } catch(e){ console.warn(e) } }
    }).catch(err=>{ console.error('Failed to load projects.json', err); document.getElementById('projects').innerHTML='<p>Error loading projects.</p>' });
  </script>
  
</body>
</html>
